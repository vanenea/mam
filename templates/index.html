{% extends "base.html" %}
{% block content %}

<h2 class="text-center mb-4">资金记录与可视化</h2>



<!-- 图表 -->
<div class="card">
  <div class="card-body">
    <div id="chart" style="height:400px;"></div>
  </div>
</div>

<!-- 账户图表 -->
<!--<div class="card mt-4">
  <div class="card-body">
    <h5>账户资金走势</h5>
    <div id="accountChart" style="height:400px;"></div>
  </div>
</div>-->

<!-- 表单 -->
<div class="card mb-4">
  <div class="card-body">
    <form method="POST" action="/add" class="row g-2">
      <div class="col-md-3">
        <input type="date" class="form-control" name="date" required>
      </div>
      <div class="col-md-2">
        <select class="form-select" name="user" required>
          <option value="CHEN">CHEN</option>
          <option value="DAN">DAN</option>
        </select>
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control" name="account" placeholder="账户名" required>
      </div>
      <div class="col-md-2">
        <input type="number" step="0.01" class="form-control" name="amount" placeholder="金额" required>
      </div>
      <div class="col-md-2 d-grid">
        <button class="btn btn-primary">添加记录</button>
      </div>
    </form>
  </div>
</div>
<script>
fetch("/data")
  .then(res => res.json())
  .then(data => {
    let chartDom = document.getElementById('chart');
    let myChart = echarts.init(chartDom);

    let users = Object.keys(data);
    let dates = [...new Set([].concat(...users.map(u => data[u].map(v => v.date))))].sort();

    let series = users.map(user => {
      let map = Object.fromEntries(data[user].map(v => [v.date, v.total]));
      return {
        name: user,
        type: 'line',
        data: dates.map(d => map[d] || 0)
      }
    });

    let option = {
      tooltip: { trigger: 'axis' },
      legend: { data: users },
      xAxis: { type: 'category', data: dates },
      yAxis: { type: 'value' },
      series: series
    };

    myChart.setOption(option);
  });
fetch("/account-data")
  .then(res => res.json())
  .then(data => {
    let chartDom = document.getElementById('accountChart');
    let myChart = echarts.init(chartDom);

    let accounts = Object.keys(data);
    let dates = [...new Set([].concat(...accounts.map(u => data[u].map(v => v.date))))].sort();

    let series = accounts.map(acc => {
      let map = Object.fromEntries(data[acc].map(v => [v.date, v.amount]));
      return {
        name: acc,
        type: 'line',
        data: dates.map(d => map[d] || 0)
      }
    });

    let option = {
      tooltip: { trigger: 'axis' },
      legend: { data: accounts },
      xAxis: { type: 'category', data: dates },
      yAxis: { type: 'value' },
      series: series
    };

    myChart.setOption(option);
  });
</script>

{% endblock %}